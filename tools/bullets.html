<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
</head>

<body style="margin:0;overflow:hidden">
    <script src="../three.js/build/three.js"></script>
    <script src="../three.js/examples/js/controls/OrbitControls.js"></script>
    <script>
    window.onload = function() {

        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.set(10, 10, 10);

        scene.add(new THREE.DirectionalLight(0xffffff, 1.0));
        scene.add(new THREE.AmbientLight(0x888888));

        var axisHelper = new THREE.AxisHelper(100);
        scene.add(axisHelper);

        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0, 0);

        var render = function() {
            requestAnimationFrame(render);
            controls.update();

            if (obj) {
                obj.material.uniforms.time.value += 0.001;

                var position = obj.geometry.getAttribute("position");
                position.needsUpdate = true;
            }

            renderer.render(scene, camera);
        };
        render();

        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }, false);

        main(scene);
    };

    var obj;

    var main = function(scene) {
        var count = 16;

        var tempGeometry = new THREE.Geometry();
        for (var x = 0; x < count; x++) {
            for (var y = 0; y < count; y++) {
                var i = y * count + x;
                tempGeometry.vertices.push(
                    new THREE.Vector3(x * 1.1 + 0.05, y * 1.1 + 0.05, 0),
                    new THREE.Vector3(x * 1.1 + 1.05, y * 1.1 + 0.05, 0),
                    new THREE.Vector3(x * 1.1 + 1.05, y * 1.1 + 1.05, 0),
                    new THREE.Vector3(x * 1.1 + 0.05, y * 1.1 + 1.05, 0)
                );
                tempGeometry.faces.push(
                    new THREE.Face3(i * 4 + 0, i * 4 + 1, i * 4 + 2),
                    new THREE.Face3(i * 4 + 0, i * 4 + 2, i * 4 + 3)
                );
                tempGeometry.faceVertexUvs[0].push([
                    new THREE.Vector2(0, 0),
                    new THREE.Vector2(1, 0),
                    new THREE.Vector2(1, 1),
                ]);
                tempGeometry.faceVertexUvs[0].push([
                    new THREE.Vector2(0, 0),
                    new THREE.Vector2(1, 1),
                    new THREE.Vector2(0, 1),
                ]);
            }
        }

        var geometry = new THREE.BufferGeometry();
        geometry.fromGeometry(tempGeometry);
        // geometry.addAttribute("visible", )

        obj = new THREE.Mesh(geometry, new THREE.ShaderMaterial({
            vertexShader: vertexShader,
            fragmentShader: fragmentShader,
            attributes: {
            },
            uniforms: {
                texture: {
                    type: "t",
                    value: THREE.ImageUtils.loadTexture("../images/reika.png"),
                },
                time: {
                    type: "f",
                    value: 0,
                },
            },
        }));
        scene.add(obj);
    };

    var vertexShader = [

        "uniform float time;",

        "varying vec2 vUv;",

        "void main() {",

        "    float idx = floor(position.y / 1.1) * 80.0 + floor(position.x / 1.1);",
        "    vec3 corner = vec3(floor(position.x / 1.1) * 1.1, floor(position.y / 1.1) * 1.1, 0.0);",
        "    vec3 mid = corner + vec3(0.5, 0.5, 0.0);",

        "    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);",
        "    vec4 p = projectionMatrix * mvPosition;",

        "    vUv = uv;",

        "    gl_Position = p;",

        "}",

    ].join("\n");

    var fragmentShader = [
        "uniform sampler2D texture;",

        "varying vec2 vUv;",

        "void main() {",

        "    gl_FragColor = texture2D(texture, vUv);",

        "}",

    ].join("\n");
    </script>
</body>

</html>
