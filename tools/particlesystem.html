<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
</head>

<body style="margin:0;overflow:hidden">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5/dat.gui.min.js"></script>
    <script src="../tmlib.js/build/tmlib.js"></script>
    <script src="../three.js/build/three.js"></script>
    <script src="../three.js/examples/js/controls/OrbitControls.js"></script>
    <script src="../scripts/shader/easing.js"></script>
    <script src="../scripts/elements/particlesystem.js"></script>
    <script>
    tm.main(function() {

        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.set(100, 100, 100);

        scene.add(new THREE.DirectionalLight(0xffffff, 1.0));
        scene.add(new THREE.AmbientLight(0x888888));

        var axisHelper = new THREE.AxisHelper(100);
        scene.add(axisHelper);

        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0, 0);

        var frame = 0;
        var render = function() {
            requestAnimationFrame(render);

            update(frame);
            controls.update();
            renderer.render(scene, camera);

            frame += 1;
        };

        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }, false);

        window.addEventListener('mouseup', function() {
            var t = param.texture;
            delete param.texture;
            console.log(JSON.stringify(param));
            param.texture = t;
            restart(param);
        });

        var param = {}.$extend(ParticleSystem.DEFAULT_PARAM);

        var s = function() {
            restart(param)
        };
        var gui = new dat.GUI();
        gui.remember(param);
        gui.add(param, "count", 0.0, 5000.0).onFinishChange(s);
        gui.add(param, "scale", 0.0, 500.0).onFinishChange(s);
        gui.add(param, "timeScale", 0.0, 300.0).onFinishChange(s);
        gui.add(param, "startRandom", 0.0, 3.0).onFinishChange(s);
        gui.add(param, "lifeTime", 0.0, 10.0).onFinishChange(s);
        gui.add(param, "lifeTimeRandom", 0.0, 10.0).onFinishChange(s);
        gui.add(param, "distance", 0.0, 200.0).onFinishChange(s);
        gui.add(param, "distanceRandom", 0.0, 10.0).onFinishChange(s);
        var sizeFolder = gui.addFolder("size");
        sizeFolder.add(param, "sizeFrom", 0.0, 100.0).onFinishChange(s);
        sizeFolder.add(param, "sizeTo", 0.0, 100.0).onFinishChange(s);
        sizeFolder.add(param, "sizeDuration", 0.0, 5.0).onFinishChange(s);
        sizeFolder.open();
        var texRotFolder = gui.addFolder("texRot");
        texRotFolder.add(param, "texRotFrom", 0.0, 10.0).onFinishChange(s);
        texRotFolder.add(param, "texRotTo", 0.0, 10.0).onFinishChange(s);
        texRotFolder.add(param, "texRotDuration", 0.0, 5.0).onFinishChange(s);
        var redFolder = gui.addFolder("red");
        redFolder.add(param, "redFrom", 0.0, 1.0).onFinishChange(s);
        redFolder.add(param, "redTo", 0.0, 1.0).onFinishChange(s);
        redFolder.add(param, "redDuration", 0.0, 5.0).onFinishChange(s);
        redFolder.open();
        var greenFolder = gui.addFolder("green");
        greenFolder.add(param, "greenFrom", 0.0, 1.0).onFinishChange(s);
        greenFolder.add(param, "greenTo", 0.0, 1.0).onFinishChange(s);
        greenFolder.add(param, "greenDuration", 0.0, 5.0).onFinishChange(s);
        greenFolder.open();
        var blueFolder = gui.addFolder("blue");
        blueFolder.add(param, "blueFrom", 0.0, 1.0).onFinishChange(s);
        blueFolder.add(param, "blueTo", 0.0, 1.0).onFinishChange(s);
        blueFolder.add(param, "blueDuration", 0.0, 5.0).onFinishChange(s);
        blueFolder.open();
        var alphaFolder = gui.addFolder("alpha");
        alphaFolder.add(param, "alphaFrom", 0.0, 1.0).onFinishChange(s);
        alphaFolder.add(param, "alphaTo", 0.0, 1.0).onFinishChange(s);
        alphaFolder.add(param, "alphaDuration", 0.0, 5.0).onFinishChange(s);
        alphaFolder.open();
        var easingFolder = gui.addFolder("easing");
        easingFolder.add(param, "positionEasing", easing.easing).onFinishChange(s);
        easingFolder.add(param, "sizeEasing", easing.easing).onFinishChange(s);
        easingFolder.add(param, "texRotEasing", easing.easing).onFinishChange(s);
        easingFolder.add(param, "redEasing", easing.easing).onFinishChange(s);
        easingFolder.add(param, "greenEasing", easing.easing).onFinishChange(s);
        easingFolder.add(param, "blueEasing", easing.easing).onFinishChange(s);
        easingFolder.add(param, "alphaEasing", easing.easing).onFinishChange(s);
        easingFolder.open();

        restart(param);
        render();

        // 大きさ比較用
        var jsonloader = new THREE.JSONLoader();
        jsonloader.load("../images/fighter_lined.js", function(geometry, materials) {
            var mesh = new THREE.Mesh(geometry, new THREE.MeshFaceMaterial(materials));
            mesh.scale.set(5, 5, 5);
            scene.add(mesh);
        });
    });

    var scene;
    var particleSystem;

    var restart = function(param) {
        if (particleSystem) {
            scene.remove(particleSystem);
        }

        particleSystem = new ParticleSystem(param);
        scene.add(particleSystem);
    };

    var update = function(frame) {
        if (particleSystem) {
            particleSystem.material.uniforms.now += 1;
        }
    };
    </script>
</body>

</html>
